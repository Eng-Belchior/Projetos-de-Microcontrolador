#include <Arduino.h>

// --- Bibliotecas para Sensores e Atuadores ---
#include <DHT.h>
#include <Wire.h> 
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

// --- Bibliotecas de Comunica√ß√£o (IoT) ---
#include <WiFi.h>
#include <HTTPClient.h> // Usada para enviar dados via REST/Firebase

// --- Configura√ß√µes do Sensor DHT22 ---
#define DHTPIN 4        // GPIO 4 (Pino de dados do DHT22)
#define DHTTYPE DHT22   // Define o tipo de sensor
DHT dht(DHTPIN, DHTTYPE);

// --- Configura√ß√µes dos Componentes de I/O Adicionais ---
#define BUTTON_PIN 23   // GPIO 23 para o Bot√£o (Input)
#define LED_READ_PIN 15   // GPIO 15 para o LED de Sinaliza√ß√£o de Leitura (Output)

// --- Configura√ß√µes do Display OLED I2C (128x64) ---
#define SCREEN_WIDTH 128    // Largura do display OLED
#define SCREEN_HEIGHT 64    // Altura do display OLED
#define OLED_RESET -1       // Pino de reset 
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);
// I2C Pinos: SDA = GPIO 21, SCL = GPIO 22

// --- Configura√ß√£o dos Atuadores (Rel√©s) ---
#define LAMP_PIN 19   // GPIO 19 para Rel√© 1 (L√¢mpada - Carga Monitorada/Aquecimento)
#define FAN_PIN 18    // GPIO 18 para Rel√© 2 (Ventilador - Dispositivo de Prote√ß√£o/Resfriamento)

// --- Vari√°veis de Controle de Processo ---
const float SET_POINT = 28.0;   // Temperatura para LIGAR o ventilador
const float HIST_LOWER = 27.5;  // Temperatura para DESLIGAR o ventilador (Histerese)

// =================================================================
// üö® CONFIGURA√á√ïES ESSENCIAIS - PREENCHA AQUI üö®
// =================================================================

// 1. Vari√°veis de Rede WiFi
const char* ssid = "INSIRA_SEU_WIFI_SSID";
const char* password = "INSIRA_SUA_SENHA_WIFI";

// 2. Configura√ß√£o do Endpoint Firebase REST API
// SUBSTITUA PELA URL DO SEU FIREBASE REALTIME DATABASE (EX: meuprojeto-default-rtdb.firebaseio.com)
// ** ATEN√á√ÉO: Use a mesma URL do seu dashboard HTML **
const char* FIREBASE_HOST = "controle-de-atuadores-e-iot-default-rtdb.firebaseio.com";

// =================================================================
// üöÄ IN√çCIO DO C√ìDIGO - N√ÉO PRECISA ALTERAR ABAIXO üöÄ
// =================================================================

// --- Vari√°veis de Controle de Tempo (Melhor que usar delay()) ---
unsigned long previousReadingMillis = 0;
const long readingInterval = 2000; // Intervalo de leitura autom√°tica (2 segundos)
unsigned long previousLogMillis = 0;
const long historicalLogInterval = 300000; // Intervalo para log hist√≥rico (5 minutos)

// --- Vari√°veis de Estado ---
float currentTemp_C = 0.0;
float currentHumidity = 0.0;
bool isFanOn = false;
bool isLampOn = true; // A l√¢mpada permanece LIGADA como fonte de calor monitorada

// Vari√°vel de estado do bot√£o para evitar leituras m√∫ltiplas (debounce simples)
int lastButtonState = HIGH; 

// Prot√≥tipo da nova fun√ß√£o unificada de ciclo
void executeCycle(bool isManualRead); 

// =================================================================
// FUN√á√ïES DE COMUNICA√á√ÉO (FIREBASE VIA REST)
// =================================================================

// Fun√ß√£o para gerar o payload JSON do estado atual
String generateJsonPayload(float temp, float humid, bool fanState, bool lampState) {
    String payload = "{";
    payload += "\"temperatura_celsius\": " + String(temp, 2) + ",";
    payload += "\"umidade_relativa_percentual\": " + String(humid, 1) + ",";
    payload += "\"ventilador_status\": \"";
    payload += (fanState ? "LIGADO" : "DESLIGADO");
    payload += "\",";
    payload += "\"lampada_status\": \"";
    payload += (lampState ? "LIGADA" : "DESLIGADA");
    payload += "\",";
    payload += "\"tempo_ciclo_ms\": " + String(millis()); 
    payload += "}";
    return payload;
}

/**
 * Envia o payload JSON para o Firebase Realtime Database usando a API REST (HTTPClient).
 * @param dataType A chave/caminho no Firebase (ex: "realtime_state").
 * @param payload A string JSON contendo os dados.
 */
void sendDataToFirestore(const String& dataType, const String& payload) {
    if (WiFi.status() == WL_CONNECTED) {
        
        // Constr√≥i a URL completa: host + path (dataType) + extens√£o JSON
        String url = "https://"; 
        url += FIREBASE_HOST;
        url += "/";
        url += dataType; // Ex: /realtime_state ou /historical_log
        url += ".json"; // Necess√°rio para a API REST do Firebase

        Serial.print("üì° Enviando Log para: ");
        Serial.println(url);

        HTTPClient http;
        http.begin(url); 
        http.addHeader("Content-Type", "application/json");
        
        int httpResponseCode;

        // üí° CORRE√á√ÉO CR√çTICA: 
        if (dataType == "realtime_state" || dataType == "manual_state") {
            // Usa PUT para SOBRESCREVER o n√≥. Isso garante que a URL do HTML n√£o fique vazia.
            Serial.println("  -> Usando PUT para Realtime State.");
            httpResponseCode = http.PUT(payload);
        } else {
            // Usa POST para ADICIONAR um registro (com ID √∫nico) no log hist√≥rico.
            Serial.println("  -> Usando POST para Log Hist√≥rico.");
            httpResponseCode = http.POST(payload);
        }


        if (httpResponseCode > 0) {
            Serial.print("‚úÖ HTTP Code: ");
            Serial.println(httpResponseCode);
        } else {
            Serial.print("‚ùå Erro no envio HTTP. C√≥digo: ");
            Serial.println(httpResponseCode);
        }
        
        http.end();
        
    } else {
        Serial.println("‚ùå WiFi Desconectado. N√£o foi poss√≠vel enviar dados.");
    }
}


// =================================================================
// FUN√á√ïES DE CONTROLE DE HARDWARE
// =================================================================

// Fun√ß√£o para inicializar o WiFi
void setupWiFi() {
    WiFi.begin(ssid, password);
    Serial.print("Conectando ao WiFi...");
    
    // Tenta conectar por 20 segundos
    int count = 0;
    while (WiFi.status() != WL_CONNECTED && count < 40) {
        delay(500);
        Serial.print(".");
        count++;
    }
    
    if (WiFi.status() == WL_CONNECTED) {
        Serial.println("\n‚úÖ Conectado!");
        Serial.print("IP: ");
        Serial.println(WiFi.localIP());
    } else {
        Serial.println("\n‚ùå Falha na Conex√£o WiFi. Continuando offline.");
    }
}

// Fun√ß√£o de Leitura do DHT22
void readSensor() {
    float h = dht.readHumidity();
    float t = dht.readTemperature(); // L√™ em Celsius

    if (isnan(h) || isnan(t)) {
        Serial.println("‚ùå Erro ao ler o sensor DHT22!");
        return;
    }

    currentHumidity = h;
    currentTemp_C = t;
}

// Implementa a L√≥gica de Controle ON/OFF com Histerese
void controlActuators() {
    
    // 1. Controle do Ventilador (Prote√ß√£o T√©rmica)
    if (currentTemp_C >= SET_POINT) {
        isFanOn = true; // LIGA o ventilador
    } else if (currentTemp_C <= HIST_LOWER) {
        isFanOn = false; // DESLIGA o ventilador (evita o 'chattering')
    }
    
    // 2. Acionamento dos Rel√©s (Sa√≠das Digitais)
    // Nota: A maioria dos m√≥dulos rel√© ativam com LOW (l√≥gica invertida). 
    // Ajuste se o seu m√≥dulo precisar de HIGH para LIGAR.
    
    // L√¢mpada (Fonte de Aquecimento/Carga Monitorada) - Sempre LIGADA
    digitalWrite(LAMP_PIN, isLampOn ? HIGH : LOW);
    
    // Ventilador (Dispositivo de Prote√ß√£o)
    digitalWrite(FAN_PIN, isFanOn ? HIGH : LOW);
    
    // Log no Serial
    Serial.print("Temp: ");
    Serial.print(currentTemp_C);
    Serial.print("\u00B0C | Humid: ");
    Serial.print(currentHumidity);
    Serial.print("% | L√¢mpada: ");
    Serial.print(isLampOn ? "ON" : "OFF");
    Serial.print(" | Ventilador: ");
    Serial.println(isFanOn ? "ON" : "OFF");
}

// Fun√ß√£o para atualizar o display OLED
void updateOLED() {
    display.clearDisplay();
    display.setTextColor(WHITE);
    
    // --- 1. Linha Superior: Status e Setpoint (Tamanho 1) ---
    display.setTextSize(1);
    display.setCursor(0, 0);

    // Exibe o Setpoint no canto superior esquerdo
    display.print("SP:");
    display.print(SET_POINT, 1);
    display.print("\u00B0C");

    // Exibe o Status da Rede no canto superior direito
    display.setCursor(70, 0);
    if (WiFi.status() == WL_CONNECTED) {
        display.print("WIFI OK");
    } else {
        display.print("WIFI OFF");
    }


    // --- 2. Linha Principal: Temperatura Atual (Tamanho 3 - Bem Grande) ---
    // Come√ßa na linha 16 (abaixo da linha 0)
    display.setTextSize(3);
    display.setCursor(0, 16); 
    display.print(currentTemp_C, 1);
    display.print("\u00B0C"); // O caracter especial de grau pode ser necess√°rio para a fonte 3
    
    // Para caber na tela, movemos a umidade para o lado direito na mesma linha
    // Verifica se a temperatura n√£o √© muito grande para dar espa√ßo √† umidade
    if (currentTemp_C < 100.0) {
        display.setTextSize(1); // Voltamos ao tamanho 1 para a Umidade
        display.setCursor(95, 24); // Posi√ß√£o calculada para ficar alinhada com a T
        display.print(currentHumidity, 0);
        display.print("%");
    }


    // --- 3. Linha Inferior: Atuadores e Leitura (Tamanho 2) ---
    // Come√ßa na linha 48 (√∫ltima √°rea livre)
    display.setTextSize(2);
    display.setCursor(0, 48);
    
    // L√¢mpada (LMP)
    display.print("LMP:");
    display.print(isLampOn ? "ON" : "OFF");
    
    // Ventilador (FAN) - Posi√ß√£o ajustada para caber
    display.setCursor(80, 48);
    display.print("FAN:");
    display.print(isFanOn ? "ON" : "OFF");
    
    display.display();
}

/**
 * Fun√ß√£o unificada que executa o ciclo completo de leitura, controle, display e log.
 * isManualRead: true se for acionada pelo bot√£o, false se for autom√°tica.
 */
void executeCycle(bool isManualRead) {
    // 1. Sinaliza o LED 
    digitalWrite(LED_READ_PIN, HIGH);
    
    // 2. Leitura e L√≥gica
    readSensor();
    controlActuators();
    
    // 3. Atualiza√ß√£o do Display
    updateOLED();
    
    // 4. Envio de Log em Tempo Real
    String logType = isManualRead ? "manual_state" : "realtime_state";
    String realtimePayload = generateJsonPayload(currentTemp_C, currentHumidity, isFanOn, isLampOn);
    sendDataToFirestore(logType, realtimePayload);
    
    // 5. Desliga o LED ap√≥s o ciclo 
    digitalWrite(LED_READ_PIN, LOW);
}


// =================================================================
// ARDUINO SETUP E LOOP
// =================================================================

void setup() {
    Serial.begin(115200);
    
    // 1. Inicializa Pinos de Sa√≠da (Atuadores e LED) 
    pinMode(LAMP_PIN, OUTPUT);
    pinMode(FAN_PIN, OUTPUT);
    pinMode(LED_READ_PIN, OUTPUT); // LED de Sinaliza√ß√£o
    
    // 2. Inicializa Pinos de Entrada (Bot√£o) 
    pinMode(BUTTON_PIN, INPUT_PULLUP); // Bot√£o usa pull-up interno

    // Garante que o ventilador e o LED comecem DESLIGADOS
    digitalWrite(LAMP_PIN, isLampOn ? HIGH : LOW);
    digitalWrite(FAN_PIN, LOW);
    digitalWrite(LED_READ_PIN, LOW);
    
    // 3. Inicializa Sensor e Display
    dht.begin();
    
    if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { // Endere√ßo I2C 0x3C (comum)
        Serial.println(F("‚ùå Falha no display SSD1306"));
    } else {
        Serial.println("‚úÖ Display OLED OK!");
        display.display();
        delay(2000);
    }
    
    // 4. Inicializa WiFi (Conex√£o IoT)
    setupWiFi();
    
    Serial.println("Setup Completo. Iniciando Loop...");
}

void loop() {
    unsigned long currentMillis = millis();

    // --- 1. L√≥gica do Bot√£o ---
    int currentButtonState = digitalRead(BUTTON_PIN);

    // Detecta a borda de descida (bot√£o sendo pressionado)
    if (currentButtonState == LOW && lastButtonState == HIGH) {
        Serial.println("Botao pressionado! Forcando ciclo de leitura...");
        executeCycle(true); // Executa o ciclo manualmente
        previousReadingMillis = currentMillis; // Reseta o timer autom√°tico
    }
    lastButtonState = currentButtonState;

    // --- 2. Execu√ß√£o Autom√°tica do Ciclo ---
    if (currentMillis - previousReadingMillis >= readingInterval) {
        previousReadingMillis = currentMillis;
        executeCycle(false); // Executa o ciclo automaticamente
    }
    
    // --- 3. Envio de Log Hist√≥rico ---
    if (currentMillis - previousLogMillis >= historicalLogInterval) {
        previousLogMillis = currentMillis;
        // N√£o precisamos de um ciclo completo para o hist√≥rico, apenas enviamos os dados atuais
        String historicalPayload = generateJsonPayload(currentTemp_C, currentHumidity, isFanOn, isLampOn);
        sendDataToFirestore("historical_log", historicalPayload);
    }
}
