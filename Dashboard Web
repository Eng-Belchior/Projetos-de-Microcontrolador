<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Atuadores e IoT</title>
    <!-- Carrega Tailwind CSS para estiliza√ß√£o moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .data-card {
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .data-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        /* Estilo para status LIGADO */
        .status-on { background-color: #10b981; color: white; } /* Green-500 */
        /* Estilo para status DESLIGADO */
        .status-off { background-color: #f87171; color: white; } /* Red-400 */
        
        .status-indicator { padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 600; font-size: 0.875rem; }
        .status-connecting { background-color: #fbbf24; color: #78350f; } /* Amber-400 */
        .status-connected { background-color: #10b981; color: white; } /* Green-500 */
        .status-error { background-color: #ef4444; color: white; } /* Red-500 */
    </style>
    <!-- Carrega o SDK do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

    <div class="container mx-auto p-4 sm:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Monitoramento IoT em Tempo Real</h1>
            <p class="text-gray-500 mt-2">Dados do ESP32 via Firebase Realtime Database</p>
            <p id="data-host" class="text-xs mt-1 text-gray-400"></p>
            
            <!-- NOVO INDICADOR DE STATUS DE CONEX√ÉO -->
            <div class="mt-4">
                <span id="connection-status" class="status-indicator status-connecting">
                    Conectando ao Firebase...
                </span>
            </div>

        </header>

        <!-- Container de Dados em Tempo Real -->
        <div id="data-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            
            <!-- Card de Temperatura -->
            <div class="data-card p-6 flex flex-col items-center">
                <span class="text-2xl text-blue-500 mb-2">üå°Ô∏è</span>
                <h2 class="text-lg font-semibold text-gray-600 mb-3">Temperatura</h2>
                <div class="text-4xl font-bold text-gray-800" id="temperatura_celsius">--,- ¬∞C</div>
                <p class="text-sm text-gray-400 mt-2">Em tempo real</p>
            </div>

            <!-- Card de Umidade -->
            <div class="data-card p-6 flex flex-col items-center">
                <span class="text-2xl text-indigo-500 mb-2">üíß</span>
                <h2 class="text-lg font-semibold text-gray-600 mb-3">Umidade</h2>
                <div class="text-4xl font-bold text-gray-800" id="umidade_relativa_percentual">--,- %</div>
                <p class="text-sm text-gray-400 mt-2">Em tempo real</p>
            </div>

            <!-- Card de Ventilador -->
            <div class="data-card p-6 flex flex-col items-center">
                <span class="text-2xl text-green-500 mb-2">üí®</span>
                <h2 class="text-lg font-semibold text-gray-600 mb-3">Ventilador (Rel√© 2)</h2>
                <div id="ventilador_status" class="py-1 px-3 rounded-full text-xl font-bold status-off">
                    CARREGANDO...
                </div>
                <p class="text-sm text-gray-400 mt-2">Controle de Resfriamento</p>
            </div>

            <!-- Card de L√¢mpada -->
            <div class="data-card p-6 flex flex-col items-center">
                <span class="text-2xl text-yellow-500 mb-2">üí°</span>
                <h2 class="text-lg font-semibold text-gray-600 mb-3">L√¢mpada (Rel√© 1)</h2>
                <div id="lampada_status" class="py-1 px-3 rounded-full text-xl font-bold status-on">
                    CARREGANDO...
                </div>
                <p class="text-sm text-gray-400 mt-2">Carga Monitorada</p>
            </div>

        </div> <!-- Fim do Container de Cards -->

        <!-- Informa√ß√£o Adicional do Log -->
        <div class="mt-8 p-4 bg-white rounded-xl shadow-lg data-card text-center">
            <h3 class="text-lg font-semibold text-gray-600 mb-2">Detalhes da √öltima Leitura</h3>
            <p class="text-sm text-gray-500">
                Tempo do Ciclo (ms): <span id="tempo_ciclo_ms" class="font-mono text-gray-700">Aguardando...</span>
            </p>
        </div>
        
    </div> <!-- Fim do Container Principal -->

    <script>
        // üö® CONFIGURA√á√ÉO DO FIREBASE 
        const FIREBASE_HOST = "controle-de-atuadores-e-iot-default-rtdb.firebaseio.com";
        const DATA_PATH = "realtime_state"; // Caminho dos dados no seu Firebase

        const firebaseConfig = {
            databaseURL: `https://${FIREBASE_HOST}`
        };

        const statusElement = document.getElementById('connection-status');

        function updateConnectionStatus(text, className) {
            statusElement.textContent = text;
            statusElement.className = `status-indicator ${className}`;
        }

        document.getElementById('data-host').textContent = `Conectado a: ${firebaseConfig.databaseURL}`;
        
        // --- FUN√á√ÉO DE UTILIDADE PARA DETECTAR POST/PUSH INESPERADO ---
        // Se o ESP estiver usando POST em vez de PUT, ele cria chaves aleat√≥rias (Ex: -Nf7G_j...)
        // Esta fun√ß√£o encontra o objeto mais recente nessa estrutura.
        function getLastDataChild(data) {
            let latestKey = null;
            
            // As chaves geradas pelo Firebase s√£o orden√°veis (semelhantes a timestamp)
            // O loop encontra a maior (mais recente) chave.
            for (const key in data) {
                if (key.startsWith('-')) { // Filtra apenas chaves aleat√≥rias do tipo push
                    if (latestKey === null || key > latestKey) {
                        latestKey = key;
                    }
                }
            }
            return latestKey ? data[latestKey] : null;
        }

        // 1. Inicializa o Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            
            const fullRefPath = `${firebaseConfig.databaseURL}/${DATA_PATH}`;
            console.log(`üì° MONITORANDO O CAMINHO: ${fullRefPath}`);

            // 2. Refer√™ncia ao n√≥ de dados em tempo real
            const realtimeRef = database.ref(DATA_PATH);

            // 3. Listener para atualiza√ß√£o em tempo real
            realtimeRef.on('value', (snapshot) => {
                let data = snapshot.val();

                if (data) {
                    let isPostStructure = false;
                    
                    // Verifica se o objeto principal j√° tem as chaves (estrutura PUT/PATCH)
                    if (data.temperatura_celsius === undefined) {
                        // N√£o tem, o que sugere que o ESP est√° enviando via POST/push e criando um n√≥ filho
                        const childData = getLastDataChild(data);
                        
                        if (childData && childData.temperatura_celsius !== undefined) {
                            // Estrutura POST detectada, mas conseguimos extrair o dado
                            data = childData;
                            isPostStructure = true;
                        } else {
                            // Estrutura inesperada ou n√≥ vazio (pode ter lixo)
                            updateConnectionStatus("Conectado, Estrutura Inesperada", 'status-connecting');
                            console.warn("‚ö†Ô∏è N√≥ n√£o est√° vazio, mas a estrutura √© ileg√≠vel. Conte√∫do:", data);
                            return; 
                        }
                    } 
                    
                    // Se chegarmos aqui, 'data' tem o payload de sensores/atuadores.
                    
                    if (isPostStructure) {
                        // O status visual agora √© "Conex√£o Est√°vel" (verde)
                        updateConnectionStatus("Conex√£o Est√°vel", 'status-connected');
                    } else {
                         updateConnectionStatus("Conectado e Recebendo Dados", 'status-connected');
                    }
                    
                    console.log("‚úÖ Dados recebidos e processados:", data);
                    
                    // --- Atualiza os Sensores (Temperatura e Umidade) ---
                    document.getElementById('temperatura_celsius').textContent = 
                        data.temperatura_celsius ? `${data.temperatura_celsius.toFixed(1)} ¬∞C` : '--,- ¬∞C';
                    
                    document.getElementById('umidade_relativa_percentual').textContent = 
                        data.umidade_relativa_percentual ? `${data.umidade_relativa_percentual.toFixed(0)} %` : '--,- %';

                    // --- Atualiza Atuadores (Status LIGADO/DESLIGADO) ---
                    
                    const fanStatusElement = document.getElementById('ventilador_status');
                    const lampStatusElement = document.getElementById('lampada_status');

                    const updateActuatorStatus = (element, status) => {
                        element.textContent = status;
                        element.classList.remove('status-on', 'status-off');
                        if (status === 'LIGADO' || status === 'LIGADA') {
                            element.classList.add('status-on');
                        } else {
                            element.classList.add('status-off');
                        }
                    };

                    updateActuatorStatus(fanStatusElement, data.ventilador_status || 'DESCONHECIDO');
                    updateActuatorStatus(lampStatusElement, data.lampada_status || 'DESCONHECIDO');

                    // --- Atualiza o Tempo do Ciclo ---
                    document.getElementById('tempo_ciclo_ms').textContent = data.tempo_ciclo_ms || 'N/A';
                    
                } else {
                    // O n√≥ est√° REALMENTE vazio
                    updateConnectionStatus("Conectado, mas N√≥ Vazio", 'status-connecting'); 
                    console.log("‚ö†Ô∏è N√≥ Vazio. Verifique o C++ e o Console do Firebase.");
                }
            }, (error) => {
                // Erro na leitura do Firebase
                updateConnectionStatus("Erro na Conex√£o Firebase", 'status-error');
                console.error("‚ùå ERRO GRAVE DE LEITURA DO FIREBASE:", error);
            });

        } catch (e) {
            // Erro na inicializa√ß√£o do SDK
            updateConnectionStatus("Erro de Inicializa√ß√£o do SDK", 'status-error');
            console.error("‚ùå ERRO FATAL AO INICIALIZAR O FIREBASE:", e);
        }

    </script>
</body>
</html>
